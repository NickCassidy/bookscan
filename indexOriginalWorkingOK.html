<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Book Scan</title>
<script src="cordova.js"></script>
<script src="https://mysqljs.com/mysql.js"></script>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script>

// the barcodeScanner plugin returns a js object with array of three items: {"cancelled":0, "text":"the isbn number", "format":"isbn format"} am storing these in the result variable.  

function scan()
  {
    console.log("Scan started");
 
    cordova.plugins.barcodeScanner.scan(function(result)
              
    {

//convert js object into json string, save in a variable
    var txt = (JSON.stringify(result));

// build and display the url
// pull out the isbn number
    var isbnNumber = result["text"];

//first part of url. K1XA9ULM is isbndb API key 
    var firstPartURL = "http://isbndb.com/api/v2/json/K1XA9ULM/book/";

// if variable is set without var = it has global scope in js...
    completeURL = firstPartURL.concat(isbnNumber);

//flush any old content from the divs on the page 
    document.getElementById("demo1").innerHTML="";
    document.getElementById("demo2").innerHTML="";

// call next step
    read_json();

    });
  }

//------- call API and parse json...

function read_json()
  {

  $.getJSON(completeURL, function(bookArray) 

    {
  
// if book not found, display error msg
    if (bookArray.error)
      {
      alert(bookArray.error);
      function javascript_abort()
        {
        }
      }
console.log(bookArray.data[0].summary);
console.log(bookArray.data[0].title);

//save data in variable for posting into DB
      title = bookArray.data[0].title;

//display title of book in 'demo1' in html
      document.getElementById("demo1").innerHTML += bookArray.data[0].title;

// sometimes summary is empty, so in this case, use notes field. If bookArray.data[0].summary is true... ie contains content
      if (bookArray.data[0].summary)
          {
          summary = bookArray.data[0].summary;
          document.getElementById("demo2").innerHTML += bookArray.data[0].summary;
          }
      else 
          {
          summary = bookArray.data[0].notes;
          document.getElementById("demo2").innerHTML += bookArray.data[0].notes; 
          }

//call next step - open browser with book json after a short delay 
    setTimeout(function ()
    {
    openBrowser();
    }, 2000); 

    });
  };
//-------- end of call API parse json

//InAppBrowser - a cordova script to open new browser window. This code renders json from API in a new page after function is called by CTA

function openBrowser() 
  {
   
   var url = completeURL;
   var target = '_blank';
   var options = "location=yes"
   var ref = cordova.InAppBrowser.open(url, target, options);

   ref.addEventListener('loadstart', loadstartCallback);
   ref.addEventListener('loadstop', loadstopCallback);
   ref.addEventListener('loadloaderror', loaderrorCallback);
   ref.addEventListener('exit', exitCallback);

   function loadstartCallback(event) {
      console.log('Loading started: '  + event.url)
   }

   function loadstopCallback(event) {
      console.log('Loading finished: ' + event.url)
   }

   function loaderrorCallback(error) {
      console.log('Loading error: ' + error.message)
   }

   function exitCallback() {
      console.log('Browser is closed...')
   }


//call js service that handles posting / retrieving mysql data (http://www.mysqljs.com/)

MySql.Execute
    (
    "sql8.freemysqlhosting.net", 
    "sql8185513", 
    "zwqj58T6c3", 
    "sql8185513", 

"insert into books (title, summary) VALUES ('"+title+"','"+summary+"')",
    );
}


</script>
</head>
<body>
<h3>Book scan</h3>
<button onclick="scan()">SCAN</button>
<p id="demo1"></p>
<p id="demo2"></p>
</body>
</html>