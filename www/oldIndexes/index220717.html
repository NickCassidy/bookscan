
<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <title>BarCode Scanner - PhoneGapPro.com</title>
 <script type="text/javascript" src="cordova.js"></script>
<script src="https://mysqljs.com/mysql.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

 <script type="text/javascript">
 function scan(){
 
 console.log("Scan started");
 
 cordova.plugins.barcodeScanner.scan(function(result){
 //success callback

//alert(JSON.stringify(result));
// the barcodeScanner app returns a json file comprising an array of three items: {"cancelled":0, "text":"THE ISBN NUMBER", "format":"isbn format"} and these are stored in the result variable. To access the isbn number, we select the second item in the array: result["text"] 

//retrieve json and convert to array
var txt = (JSON.stringify(result));

// build and display the url
//document.getElementById("demo").innerHTML = "http://isbndb.com/api/v2/json/K1XA9ULM/book/".concat(result["text"]);

var isbnNumber = result["text"];

//full url only K1XA9ULM is isbndb API key
var firstPartURL = "http://isbndb.com/api/v2/json/K1XA9ULM/book/";
var completeURL = firstPartURL.concat(isbnNumber);

//alert (completeURL);
alert (completeURL);

//save completeURL in a cookie to allow it to be retrieved in openBrowser function below
document.cookie = 'scannedURL=' +completeURL+';'; 

//log output
console.log('Cookie set :'.concat(completeURL));

});

}


//------- jquery to parse API json...


// convert book json into array uses heroukapp url to workaround cross site scripting

function read_json(){


//$.getJSON('http://cors-anywhere.herokuapp.com/http://isbndb.com/api/v2/json/K1XA9ULM/book/9780192804571', function(bookArray) {
    //console.log(bookArray.index_searched);

    $.getJSON('http://isbndb.com/api/v2/json/K1XA9ULM/book/9780192804571', function(bookArray) {
    //console.log(bookArray.index_searched);
    console.log(bookArray.data[0].book_id);

var bookCookie = bookArray.data[0].book_id;

document.getElementById("demo").innerHTML += bookArray.data[0].book_id;


// save book id into cookie for later on...
document.cookie = 'book_id=' +bookCookie+';'; 

console.log('Cookie set :'.concat(bookCookie));

});

};



//-------- end jquery to parse API json


//for openBrowser functionality if want to use a link: <div id="openBrowser">open</div>
//document.getElementById("openBrowser").addEventListener("click", openBrowser);
// this code renders json from API on a new browser page after user hits GO button

function openBrowser() {
   var retrievedURL = document.cookie;
   //slice 'scannedURL=' from cookie value
   var url = retrievedURL.slice(11);
   //alert(url);
   var target = '_blank';
   var options = "location=yes"
   var ref = cordova.InAppBrowser.open(url, target, options);

   ref.addEventListener('loadstart', loadstartCallback);
   ref.addEventListener('loadstop', loadstopCallback);
   ref.addEventListener('loadloaderror', loaderrorCallback);
   ref.addEventListener('exit', exitCallback);

   function loadstartCallback(event) {
      console.log('Loading started: '  + event.url)
   }

   function loadstopCallback(event) {
      console.log('Loading finished: ' + event.url)
   }

   function loaderrorCallback(error) {
      console.log('Loading error: ' + error.message)
   }

   function exitCallback() {
      console.log('Browser is closed...')
   }

}





    




/*-----*/
/* this code calls a js service that handles posting/retrieving mysql data 
http://www.mysqljs.com/
see script tag at top of page and <pre> tag below
*/
MySql.Execute(
    "sql8.freemysqlhosting.net", 
    "sql8185513", 
    "zwqj58T6c3", 
    "sql8185513", 
//"select * from books", 
//        function (data) {
//        document.getElementById("output").innerHTML = JSON.stringify(data,null,2);

    
"insert into books (title, author, rating) VALUES ('Bah', 'Yad', '2.4')",

function (data) {
//document.getElementById("output").innerHTML = JSON.stringify(data,null,2);
console.log(data)

});

/*-----*/
//delete scannedURL cookie
 document.cookie = "scannedURL=; expires=Thu, 01 Jan 1970 00:00:00 UTC;";

alert ('yeah'); 

</script>




</head>
<body>
 <h3>BOOK SCAN</h3>
 <button onclick="read_json()">json</button>
 <button onclick="scan()">SCAN</button>
<p id="demo"></p>
<button onclick="openBrowser()">GO</button>
<pre id="output"></pre>
</body>
</html>